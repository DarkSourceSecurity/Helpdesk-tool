<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Helpdesk Debugger & Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-10 text-slate-900 font-sans">
    <div class="max-w-5xl mx-auto">
        <header class="mb-8 border-b border-slate-300 pb-6">
            <h1 class="text-3xl font-black text-slate-800 uppercase tracking-tighter">Diagnostic Helpdesk Tool</h1>
            <p class="text-slate-600">Identifying headers and processing multi-line data...</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-sm border">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Current CSV</label>
                <input type="file" id="currentFile" accept=".csv" class="w-full text-sm"/>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border">
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-2">Archive CSV</label>
                <input type="file" id="archiveFile" accept=".csv" class="w-full text-sm"/>
            </div>
        </div>

        <button onclick="processData()" class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold shadow-lg hover:bg-blue-700 mb-8 transition-all">
            Process & Debug Data
        </button>

        <div id="debugLog" class="bg-black text-lime-400 p-4 rounded-lg font-mono text-xs mb-8 min-h-[100px] overflow-y-auto shadow-inner">
            > System Ready. Upload files to begin...
        </div>

        <div id="results" class="hidden space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-500 uppercase text-xs mb-4">Volume Distribution</h3>
                    <div class="h-64"><canvas id="volChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-500 uppercase text-xs mb-4">Top Keywords</h3>
                    <div id="keywords" class="flex flex-wrap gap-2 pt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const log = (msg) => {
            const el = document.getElementById('debugLog');
            el.innerHTML += `<br>> ${msg}`;
            el.scrollTop = el.scrollHeight;
        };

        async function processData() {
            try {
                const curFile = document.getElementById('currentFile').files[0];
                const arcFile = document.getElementById('archiveFile').files[0];
                if (!curFile || !arcFile) return alert("Select both files.");

                log("Reading files...");
                const curRaw = await parseCSV(curFile);
                const arcRaw = await parseCSV(arcFile);

                log(`Headers detected in Current: [${Object.keys(curRaw[0]).join(', ')}]`);
                
                const cleanCur = smartProcess(curRaw, 'Current');
                const cleanArc = smartProcess(arcRaw, 'Archive');

                const master = [...cleanCur, ...cleanArc];
                log(`Unique Tickets identified: ${master.length}`);

                if (master.length > 0) {
                    showDashboard(master);
                } else {
                    log("CRITICAL: 0 tickets identified. Check if 'Ticket Number' column exists.");
                }
            } catch (e) {
                log(`ERROR: ${e.message}`);
            }
        }

        function parseCSV(file) {
            return new Promise(resolve => Papa.parse(file, {header: true, skipEmptyLines: true, complete: r => resolve(r.data)}));
        }

        function smartProcess(data, source) {
            // Find keys regardless of hidden characters
            const find = (q) => Object.keys(data[0]).find(k => k.toLowerCase().replace(/[^a-z]/g, '').includes(q));
            
            const idK = find('ticketnumber') || find('id');
            const descK = find('description');
            
            log(`Using Column for Ticket ID: "${idK}"`);

            let lastID = null;
            const unique = new Map();

            data.forEach(row => {
                const id = row[idK];
                if (id && id.toString().trim() !== "") {
                    lastID = id.toString().trim();
                }
                
                if (lastID) {
                    if (!unique.has(lastID)) {
                        unique.set(lastID, { ID: lastID, Desc: "", Source: source });
                    }
                    const existing = unique.get(lastID);
                    existing.Desc += " " + (row[descK] || "");
                }
            });
            return Array.from(unique.values());
        }

        function showDashboard(data) {
            document.getElementById('results').classList.remove('hidden');
            
            // Chart
            if (window.myChart) window.myChart.destroy();
            const curN = data.filter(d => d.Source === 'Current').length;
            const arcN = data.filter(d => d.Source === 'Archive').length;
            
            window.myChart = new Chart(document.getElementById('volChart'), {
                type: 'bar',
                data: {
                    labels: ['Current', 'Archive'],
                    datasets: [{ label: 'Unique Tickets', data: [curN, arcN], backgroundColor: ['#2563eb', '#f97316'] }]
                },
                options: { maintainAspectRatio: false }
            });

            // Keywords
            const text = data.map(d => d.Desc).join(' ').toLowerCase();
            const words = text.match(/\b(\w{5,})\b/g) || [];
            const freq = {};
            words.forEach(w => { if(!['please','thank','regards','hello'].includes(w)) freq[w] = (freq[w]||0)+1; });
            const sorted = Object.entries(freq).sort((a,b) => b[1]-a[1]).slice(0, 10);
            
            document.getElementById('keywords').innerHTML = sorted.map(([w, c]) => 
                `<span class="bg-slate-200 px-3 py-1 rounded-full text-xs font-bold">${w} (${c})</span>`
            ).join('');
        }
    </script>
</body>
</html>
